<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Useful Azure CLI commands • cloudDemo</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Useful Azure CLI commands">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cloudDemo</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/cliCommands.html">Useful Azure CLI commands</a></li>
    <li><a class="dropdown-item" href="../articles/cloudSetup.html">Setting up cloud processing with Azure Batch</a></li>
    <li><a class="dropdown-item" href="../articles/parallelization.html">Parallelization</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/LandSciTech/cloudDemo/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Useful Azure CLI commands</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/LandSciTech/cloudDemo/blob/master/vignettes/cliCommands.Rmd" class="external-link"><code>vignettes/cliCommands.Rmd</code></a></small>
      <div class="d-none name"><code>cliCommands.Rmd</code></div>
    </div>

    
    
<p>This page is intended as a list of useful commands to refer back to
when using Azure CLI. Feel free to add your own by forking the <a href="https://github.com/LandSciTech/compendiumDemo" class="external-link">repo</a>, or
creating an <a href="https://github.com/LandSciTech/compendiumDemo/issues" class="external-link">issue</a>.
Some things are Azure CLI specific but some are just helpful Bash
things.</p>
<div class="section level2">
<h2 id="microsoft-help-pages">Microsoft help pages<a class="anchor" aria-label="anchor" href="#microsoft-help-pages"></a>
</h2>
<p>These have a lot of info and are where I have figured out most things
but there is so much there it is a little overwhelming.</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/cli/azure/cheat-sheet-onboarding" class="external-link">Onboarding
cheat sheet</a></li>
<li><a href="https://learn.microsoft.com/en-us/cli/azure/reference-index" class="external-link">Reference
index A to Z</a></li>
</ul>
</div>
<div class="section level2">
<h2 id="useful-commands">Useful commands<a class="anchor" aria-label="anchor" href="#useful-commands"></a>
</h2>
<div class="section level3">
<h3 id="list-pools">List pools<a class="anchor" aria-label="anchor" href="#list-pools"></a>
</h3>
<p><code>az batch pool list</code> returns all the info for every pool.
You can use <code>--query</code> to simplify this. The query below
returns the id and information on numbers of nodes for all pools. I have
also changed the <code>--output</code> from the default json to table
since it is more compact. <code>query</code> and <code>output</code> are
global parameters available for most functions.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">az</span> batch pool list <span class="dt">\</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>--query <span class="st">"[].{name:id, vmSize:vmSize,  curNodes: currentDedicatedNodes,tarNodes: targetDedicatedN</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="st">odes, allocState:allocationState}"</span> <span class="dt">\</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>--output table</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="co">#&gt; Name             VmSize          CurNodes    TarNodes    AllocState</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="co">#&gt; ---------------  --------------  ----------  ----------  ------------</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="co">#&gt; amartin_pool4    standard_d8_v3  1           1           steady</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="co">#&gt; amartin_pool5    standard_d8_v3  1           1           steady</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="co">#&gt; amartin_pool6    standard_d8_v3  1           1           steady</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="co">#&gt; sendicott_roads  standard_e2_v3  1           0           resizing</span></span></code></pre></div>
<p>To break down the query, the first <code>[]</code> means we are going
to get values from each element of an array. The part in <code><a href="https://rdrr.io/r/base/Paren.html" class="external-link">{}</a></code>
chooses which properties to return and what their display names should
be. These are JMESPath querys and they can be very powerful. See this <a href="https://learn.microsoft.com/en-us/cli/azure/query-azure-cli?tabs=concepts%2Cbash" class="external-link">help
page</a> for more details.</p>
<p>For example, we can also add a filter to the query:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="ex">az</span> batch pool list <span class="dt">\</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>--query <span class="st">"[?id == 'sendicott_roads'].{name:id, vmSize:vmSize,  curNodes: currentDedicatedNodes,tarNodes: targetDedicatedNodes, allocState:allocationState}"</span> <span class="dt">\</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>--output table</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="co">#&gt; Name             VmSize          CurNodes    TarNodes    AllocState</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="co">#&gt; ---------------  --------------  ----------  ----------  ------------</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="co">#&gt; sendicott_roads  standard_e2_v3  1           0           resizing</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="ex">az</span> batch pool list <span class="dt">\</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>--query <span class="st">"[?contains(id, 'amartin')].{name:id, vmSize:vmSize,  curNodes:currentDedicatedNodes,tarNodes: targetDedicatedNodes, allocState:allocationState}"</span> <span class="dt">\</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>--output table</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a><span class="co">#&gt; Name            VmSize          CurNodes    TarNodes    AllocState</span></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a><span class="co">#&gt; ----------      --------------  ----------  ----------  ------------</span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a><span class="co">#&gt; amartin_pool4   standard_d8_v3  1           1           steady</span></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a><span class="co">#&gt; amartin_pool5   standard_d8_v3  1           1           steady</span></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a><span class="co">#&gt; amartin_pool6   standard_d8_v3  1           1           steady</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="get-subnet-id-for-use-in-json-pool-files">Get subnet id for use in JSON pool files<a class="anchor" aria-label="anchor" href="#get-subnet-id-for-use-in-json-pool-files"></a>
</h3>
<p>We can also save the output of a query to a variable and use it in
future commands</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="va">subnetid</span><span class="op">=</span><span class="va">$(</span><span class="ex">az</span> network vnet subnet list <span class="at">--resource-group</span> EcDc-WLS-rg <span class="at">--vnet-name</span> EcDc-WLS-vnet <span class="dt">\</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>--query <span class="st">"[?name=='EcDc-WLS_compute-cluster-snet'].id"</span> <span class="at">--output</span> tsv<span class="va">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="get-sastoken-and-sasurl">Get sastoken and sasurl<a class="anchor" aria-label="anchor" href="#get-sastoken-and-sasurl"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># 7 days seems to be the max that the cli will allow</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="va">end</span><span class="op">=</span><span class="kw">`</span><span class="fu">date</span> <span class="at">-u</span> <span class="at">-d</span> <span class="st">"7 days"</span> <span class="st">'+%Y-%m-%dT%H:%MZ'</span><span class="kw">`</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="va">sastoken</span><span class="op">=</span><span class="kw">`</span><span class="ex">az</span> storage container generate-sas <span class="at">--account-name</span> ecdcwls <span class="at">--expiry</span> <span class="va">$end</span> <span class="at">--name</span> sendicott <span class="at">--permissions</span> racwdli <span class="at">-o</span> tsv <span class="at">--auth-mode</span> login <span class="at">--as-user</span><span class="kw">`</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="va">sasurl</span><span class="op">=</span>https://ecdcwls.blob.core.windows.net/sendicott/<span class="pp">?</span><span class="va">$sastoken</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="list-files-in-storage-container">List files in storage container<a class="anchor" aria-label="anchor" href="#list-files-in-storage-container"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">az</span> storage blob list <span class="at">-c</span> sendicott <span class="at">--account-name</span> ecdcwls <span class="at">--sas-token</span> <span class="va">$sastoken</span> <span class="dt">\</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>--query <span class="st">"[].{name:name}"</span> <span class="at">--output</span> yaml</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="copy-file-to-storage">Copy file to storage<a class="anchor" aria-label="anchor" href="#copy-file-to-storage"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="va">sasurl</span><span class="op">=</span>https://ecdcwls.blob.core.windows.net/sendicott/<span class="pp">?</span><span class="va">$sastoken</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="ex">az</span> storage copy <span class="at">-d</span> <span class="va">$sasurl</span> <span class="at">-s</span> analyses/scripts/run_script.sh</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="copy-folder-to-storage">Copy folder to storage<a class="anchor" aria-label="anchor" href="#copy-folder-to-storage"></a>
</h3>
<p>If you copy individual files they will end up in the root of the
storage container, if you copy a folder using <code>--recursize</code>
the folder structure will be reflected in the storage container. If you
copy the contents of the folder using a wildcard (path/to/folder/*) it
will copy each file to the root of the container.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="ex">az</span> storage copy <span class="at">-d</span> <span class="va">$sasurl</span> <span class="at">-s</span> analyses/scripts <span class="at">--recursive</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="ex">az</span> storage copy <span class="at">-d</span> <span class="va">$sasurl</span> <span class="at">-s</span> <span class="st">"analyses/scripts/*"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="copydownload-files-from-storage">Copy/download files from storage<a class="anchor" aria-label="anchor" href="#copydownload-files-from-storage"></a>
</h3>
<p>You can download files using a pattern. The below will download all
files in sendicott container that end in “.R” and save them in a new
folder called scripts2</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="ex">az</span> storage copy <span class="at">-s</span> https://ecdcwls.blob.core.windows.net/sendicott/<span class="pp">*?</span><span class="va">$sastoken</span> <span class="dt">\</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>-d <span class="st">"analyses/scripts2"</span> <span class="at">--include-pattern</span> <span class="st">"*.R"</span></span></code></pre></div>
<p>Or by adding the folder name after the container name and before
<code>?$sastoken</code>: Using recursive will copy the folder with its
contents:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="ex">az</span> storage copy <span class="at">-s</span> https://ecdcwls.blob.core.windows.net/sendicott/scripts<span class="pp">?</span><span class="va">$sastoken</span> <span class="dt">\</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>-d <span class="st">"analyses/scripts3"</span> <span class="at">--recursive</span></span></code></pre></div>
<p>But using the folder name followed by * will just copy each file</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="ex">az</span> storage copy <span class="at">-s</span> https://ecdcwls.blob.core.windows.net/sendicott/scripts/<span class="pp">*?</span><span class="va">$sastoken</span> <span class="dt">\</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>-d <span class="st">"analyses/scripts4"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="delete-files-on-storage">Delete files on storage<a class="anchor" aria-label="anchor" href="#delete-files-on-storage"></a>
</h3>
<p>Remove files matching pattern:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="ex">az</span> storage remove <span class="at">-c</span> sendicott <span class="at">--include-pattern</span> <span class="st">"*.rds"</span> <span class="at">--account-name</span> ecdcwls <span class="at">--sas-token</span> <span class="va">$sastoken</span> <span class="at">--recursive</span></span></code></pre></div>
<p>Delete one folder</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="ex">az</span> storage remove <span class="at">-c</span> sendicott <span class="at">-n</span> scripts <span class="at">--account-name</span> ecdcwls <span class="dt">\</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>--sas-token <span class="va">$sastoken</span> <span class="at">--recursive</span></span></code></pre></div>
<p>Delete everything in container Note you can also exclude files
matching a pattern with
e.g. <code>--exclude-pattern "*.gpkg"</code>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="ex">az</span> storage remove <span class="at">-c</span> sendicott <span class="at">--account-name</span> ecdcwls <span class="dt">\</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>--sas-token <span class="va">$sastoken</span> <span class="at">--recursive</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="create-pool-job-task">Create pool, job, task<a class="anchor" aria-label="anchor" href="#create-pool-job-task"></a>
</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="va">poolName</span><span class="op">=</span><span class="st">"test_pool_json_cli"</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="va">jobName</span><span class="op">=</span><span class="st">"sendicott_job_test"</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="ex">az</span> batch pool create <span class="at">--json-file</span> cloud_config/template_pool_cli.json</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a><span class="ex">az</span> batch job create <span class="at">--pool-id</span> <span class="va">$poolName</span> <span class="at">--id</span> <span class="va">$jobName</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="ex">az</span> batch task create <span class="at">--json-file</span> cloud_config/template_task_hello.json <span class="at">--job-id</span> <span class="va">$jobName</span></span></code></pre></div>
<p>Or create many tasks with a loop. This assumes you have created may
different task jsons with different files that are numbered.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="cf">for</span> rowi <span class="kw">in</span> <span class="dt">{</span><span class="dv">1</span><span class="dt">..</span><span class="dv">27</span><span class="dt">}</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="cf">do</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>  <span class="ex">az</span> batch task create <span class="at">--json-file</span> analysis/cloud/task_jsons/task_roads_<span class="va">$rowi</span>.json <span class="at">--job-id</span> <span class="va">$jobName</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="reactivate-task">Reactivate task<a class="anchor" aria-label="anchor" href="#reactivate-task"></a>
</h3>
<p>This will re-run a task that failed. Useful if you fixed one of the
scripts and re-uploaded it or if the error was a stochastic thing and
you want to try again. Won’t re-run successful tasks</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="ex">az</span> batch task reactivate <span class="at">--job-id</span> <span class="va">$jobName</span> <span class="at">--task-id</span> sampleTask</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="delete-pool-job-task">Delete Pool, job, task<a class="anchor" aria-label="anchor" href="#delete-pool-job-task"></a>
</h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co"># you will have to confirm in the console or add --yes</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="ex">az</span> batch job delete <span class="at">--job-id</span> <span class="va">$jobName</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="ex">az</span> batch pool delete <span class="at">--pool-id</span> <span class="va">$poolName</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="co"># if you delete the pool the task is deleted anyway</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="ex">az</span> batch task delete <span class="at">--task-id</span> sampleTask <span class="at">--job-id</span> <span class="va">$jobName</span> <span class="at">--yes</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="monitoring-tasks">Monitoring tasks<a class="anchor" aria-label="anchor" href="#monitoring-tasks"></a>
</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="co"># details for a single task filtered by query</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="ex">az</span> batch task show <span class="at">--job-id</span> <span class="va">$jobName</span> <span class="at">--task-id</span> sampleTask <span class="dt">\</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>--query <span class="st">"{state: state, executionInfo: executionInfo}"</span> <span class="at">--output</span> yaml</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a><span class="co"># Summary of state for all tasks in job</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a><span class="ex">az</span> batch job task-counts show <span class="at">--job-id</span> <span class="va">$jobName</span></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a><span class="co"># Get other info from multiple tasks</span></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a><span class="ex">az</span> batch task list <span class="at">--job-id</span> <span class="va">$jobName</span> <span class="dt">\</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a>--query <span class="st">"{tasks: [].[id, executionInfo.{st:startTime, end:endTime}][]}"</span> <span class="at">--output</span> yaml</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="download-output-file-from-a-task">Download output file from a task<a class="anchor" aria-label="anchor" href="#download-output-file-from-a-task"></a>
</h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="ex">az</span> batch task file download <span class="at">--task-id</span> sampleTask <span class="at">--job-id</span> <span class="va">$jobName</span> <span class="dt">\</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>--file-path <span class="st">"stdout.txt"</span> <span class="at">--destination</span> <span class="st">"cloud_config/stdout.txt"</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a><span class="co"># print the file to console</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a><span class="fu">cat</span> <span class="st">"cloud_config/stdout.txt"</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a><span class="co"># or print the last n lines </span></span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a><span class="fu">tail</span> <span class="st">"cloud_config/stdout.txt"</span> <span class="at">-n</span> 5</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="manage-nodes-in-pool">Manage nodes in pool<a class="anchor" aria-label="anchor" href="#manage-nodes-in-pool"></a>
</h3>
<p>When running many tasks in a pool I usually start one node, check
that it is working and then resize to the desired number of nodes.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co"># set target dedicated nodes</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="ex">az</span> batch pool resize <span class="at">--pool-id</span> <span class="va">$poolName</span> <span class="at">--target-dedicated-nodes</span> 3</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a><span class="co"># check pool node counts</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a><span class="ex">az</span> batch pool list  <span class="dt">\</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>--query <span class="st">"[?id=='"</span><span class="va">$poolName</span><span class="st">"'].{curNodes: currentDedicatedNodes,tarNodes: targetDedicatedNodes, allocState:allocationState}"</span> <span class="dt">\</span></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>--output yaml</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a><span class="co"># check node state</span></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a><span class="ex">az</span> batch node list <span class="at">--pool-id</span> <span class="va">$poolName</span> <span class="at">--query</span> <span class="st">"{nodes: [].[id, state][]}"</span> <span class="at">--output</span> json</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="enable-autoscaling">Enable autoscaling<a class="anchor" aria-label="anchor" href="#enable-autoscaling"></a>
</h3>
<p>Once a pool is running well and I am confident that results will be
saved as expected I enable autoscaling so that we will not be charged
after the task is finished running. This will mean that the task is
deleted after it completes so you won’t be able to look at logs or files
on it afterwards. See an example autoscaling workflow <a href="https://github.com/LandSciTech/cloudDemo/blob/master/analyses/scripts/run_azure_autoscale.sh" class="external-link">here</a>
One confusing aspect of autoscaling is that it doesn’t happen
immediately the interval set below is the shortest available and means
it will run every 5 minutes. So generally if it seems like it is not
working, wait 5 mins and check again. The formula below is hard to read,
there is documentation available <a href="https://learn.microsoft.com/en-us/azure/batch/batch-automatic-scaling" class="external-link">here</a>
and I will try to explain the logic of this example. First I have set
max VMs to 25 since our account has a max of 27, you may want to set
this lower if others are using the account at the same time. Next I find
out how many tasks are currently waiting (“active tasks”) and how many
are currently running. Unfortunately this is not a simple number because
these values are not exactly accurate in real time, they are recorded
every 30s and sometimes that process fails so the value is missing.
Therefore the recommendation is to use a sampling of values, in this
case I have chosen the last 2 minutes which returns a vector of values
recorded over the last 2 minutes. I take the max of these values and add
the current and active tasks together to get the total number of tasks
that I want to run. Then I determine the number of nodes that are
currently available. I use the max of current and target nodes so that
it will not think there are 0 nodes if the pool is still starting up or
if the target was 0 but new tasks have been added. Next I determine the
total number of tasks that can run at a time (called cores below). Then
I calculate the number of additional nodes that are needed given the
total number of tasks minus the existing number of cores and the number
of task slots per node. Then we set the target dedicated nodes making
sure it is between 0 and 25. Finally, I set the node deallocation option
so that all the tasks running on the node must finish before it is
shutdown.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co"># you can prompt autoscaling of pool by changing time interval</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="ex">az</span> batch pool autoscale enable <span class="at">--pool-id</span> <span class="va">$poolName</span> <span class="at">--auto-scale-evaluation-interval</span> <span class="st">"PT5M"</span><span class="dt">\</span></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a> <span class="at">--auto-scale-formula</span> <span class="st">'maxNumberofVMs = 25;</span></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a><span class="st"> $atasks = $ActiveTasks.GetSample(TimeInterval_Minute * 2, 1);</span></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a><span class="st"> $rtasks = $RunningTasks.GetSample(TimeInterval_Minute * 2, 1);</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a><span class="st"> $tasks = max($atasks) + max($rtasks);</span></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a><span class="st"> $nodes = max($CurrentDedicatedNodes, $TargetDedicatedNodes);</span></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a><span class="st"> $cores = $nodes*$TaskSlotsPerNode;</span></span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a><span class="st"> $extraVMs = ceil((($tasks - $cores) + 0) / $TaskSlotsPerNode);</span></span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a><span class="st"> $targetVMs = ($nodes + $extraVMs);</span></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a><span class="st"> $TargetDedicatedNodes = max(0, min($targetVMs, maxNumberofVMs));</span></span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a><span class="st"> $NodeDeallocationOption = taskcompletion;'</span> </span></code></pre></div>
<p>Although autoscaling only runs every 5 minutes you can check what the
result would be by evaluating the autoscaling formula. This only works
after autoscaling has been enabled.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="co"># This will show what the formula would return if autoscaling ran now.  </span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="ex">az</span> batch pool autoscale evaluate <span class="at">--pool-id</span> <span class="va">$poolName</span> <span class="dt">\</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>--auto-scale-formula <span class="st">'maxNumberofVMs = 25;</span></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a><span class="st"> $atasks = $ActiveTasks.GetSample(TimeInterval_Minute * 2, 1);</span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a><span class="st"> $rtasks = $RunningTasks.GetSample(TimeInterval_Minute * 2, 1);</span></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a><span class="st"> $tasks = max($atasks) + max($rtasks);</span></span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a><span class="st"> $nodes = max($CurrentDedicatedNodes, $TargetDedicatedNodes);</span></span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a><span class="st"> $cores = $nodes*$TaskSlotsPerNode;</span></span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a><span class="st"> $extraVMs = ceil((($tasks - $cores) + 0) / $TaskSlotsPerNode);</span></span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a><span class="st"> $targetVMs = ($nodes + $extraVMs);</span></span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a><span class="st"> $TargetDedicatedNodes = max(0, min($targetVMs, maxNumberofVMs));</span></span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a><span class="st"> $NodeDeallocationOption = taskcompletion;'</span> </span></code></pre></div>
<p>If autoscaling is not working as desired or you want to change the
formula you can disable autoscaling and manually set the number of nodes
needed. But make sure to turn autoscaling back on once all the tasks
have started to ensure the pool will not keep running after all tasks
are complete.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="ex">az</span> batch pool autoscale disable <span class="at">--pool-id</span> <span class="va">$poolName</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="ex">az</span> batch pool resize <span class="at">--pool-id</span> <span class="va">$poolName</span> <span class="at">--target-dedicated-nodes</span> 12</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="monitor-cpu-usage-and-memory">Monitor CPU usage and memory<a class="anchor" aria-label="anchor" href="#monitor-cpu-usage-and-memory"></a>
</h3>
<p>To check the CPU usage and memory usage on a node we can run an
additional task on the same node by setting multiple taskSlotsPerNode.
Follow <a href="https://github.com/LandSciTech/cloudDemo/blob/master/analyses/scripts/run_azure_monitor.sh" class="external-link">this
script</a> to set up a monitoring task and produce a graph of memory
usage based on the values returned.</p>
</div>
<div class="section level3">
<h3 id="get-github-pat-token">Get GitHub PAT token<a class="anchor" aria-label="anchor" href="#get-github-pat-token"></a>
</h3>
<p>There is probably another way to set and retrieve a GitHub PAT within
bash but this was the simplest way I found to get the token so I could
supply it to a script programatically to avoid saving it in files that
might accidentally get shared.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="va">ghpat</span><span class="op">=</span><span class="kw">`</span><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"cat(gh::gh_token())"</span><span class="kw">`</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="use-sed-to-replace-placeholder-text-in-files">Use <code>sed</code> to replace placeholder text in files<a class="anchor" aria-label="anchor" href="#use-sed-to-replace-placeholder-text-in-files"></a>
</h3>
<p>sed is a command line tool that allows you to replace a placeholder
in a text file with a value generated by your script for example using
the sastoken created above:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="fu">sed</span> <span class="st">'s,&lt;sastoken&gt;,'</span><span class="va">${sastoken</span><span class="op">//</span><span class="ss">&amp;</span><span class="op">/</span><span class="dt">\\</span>&amp;<span class="va">}</span><span class="st">',g'</span> cloud_config/template_task_with_file_in_out.json <span class="op">&gt;</span> cloud_config/task_to_use.json</span></code></pre></div>
<p>This is important to avoid hard coding secret passwords or token in
to your saved files. And you should remove the “to_use” file that
contains the password when you are done
(<code>rm cloud_config/task_to_use.json</code>). You can also add
<code>*to_use*</code> to your .gitignore file to make sure they don’t
accidentally get added to GitHub.</p>
<p>The syntax of sed is a bit tricky and is complicated by special
characters in sastoken. In the command above the s indicates we want to
use seds subsitiution command, the comma (,) is a delimiter that shows
the start of the string to be replaced. “&lt;sastoken&gt;” is the text
to be replaced (the &lt;&gt; doesn’t have any special meaning it is just
convention for placeholders). The second comma shows the start of the
string to replace it with. The $ means that the part inside the {} will
be evaluated first and then be part of the sed command. The
<code>//&amp;/\\&amp;</code> will just add a <code>\</code> before all
the &amp; in the sastoken so they don’t get interpreted as special
characters by sed. The third comma shows the end of the text to replace
with and the g indicates that every instance of the pattern should be
replaced. Finally the first path is the template file containing the
placeholder and the second is the path to the file to create.
<code>/</code> is the default delimiter used in sed but it doesn’t work
if there are slashes in the replacement text so I have used commas
instead. See the <a href="https://tldp.org/LDP/abs/html/x23170.html" class="external-link">sed
documentation</a> for more details and examples.</p>
<p>You can also use sed with a loop to create many different versions of
a file:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="cf">for</span> rowi <span class="kw">in</span> <span class="dt">{</span><span class="dv">1</span><span class="dt">..</span><span class="dv">27</span><span class="dt">}</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="cf">do</span></span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>  <span class="fu">sed</span> <span class="st">'s,&lt;SASURL&gt;,'</span><span class="va">${sasurl</span><span class="op">//</span><span class="ss">&amp;</span><span class="op">/</span><span class="dt">\\</span>&amp;<span class="va">}</span><span class="st">',g'</span> analysis/cloud/task_roads.json<span class="dt">\</span></span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>  <span class="kw">|</span> <span class="fu">sed</span> <span class="st">'s,&lt;row&gt;,'</span><span class="va">$rowi</span><span class="st">',g'</span> <span class="op">&gt;</span> analysis/cloud/task_jsons/task_roads_<span class="va">$rowi</span>.json</span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<p>The above first replaces <code>&lt;SASURL&gt;</code> in the file and
then uses the pipe <code>|</code> to pass the result on to another sed
command that replaces <code>&lt;row&gt;</code> with the loop index
<code>rowi</code> and saves it to a file with the row appended. This can
be helpful for creating many different versions of a task.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sarah Endicott.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
